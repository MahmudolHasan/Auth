<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baseera - Reset Password</title>
<style>
  /* -------------------- Global -------------------- */
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex; justify-content: center; align-items: center;
    padding:16px;
  }
  .container { max-width:420px; width:100%; }
  .card {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-radius:24px;
    padding:32px 24px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    animation: slideUp 0.5s ease-out;
  }
  @keyframes slideUp { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

  /* -------------------- Logo -------------------- */
  .logo { text-align:center; margin-bottom:24px; }
  .logo-circle {
    width:64px; height:64px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    margin:0 auto 12px;
    font-size:28px; font-weight:bold; color:white;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  .logo-text {
    font-size:20px; font-weight:600;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* -------------------- Text -------------------- */
  h2 { color:#1f2937; font-size:24px; font-weight:700; margin-bottom:8px; text-align:center; }
  .subtitle { color:#6b7280; font-size:14px; text-align:center; margin-bottom:24px; line-height:1.5; }

  /* -------------------- Info Box -------------------- */
  .info-box { background:#f3f4f6; border-radius:16px; padding:16px; margin-bottom:24px; border-left:4px solid #10b981; }
  .info-box p { color:#374151; font-size:14px; line-height:1.5; }

  /* -------------------- Token -------------------- */
  .token-container { background:white; border:2px solid #e5e7eb; border-radius:14px; padding:16px; margin:20px 0; transition: all 0.3s ease; }
  .token-container:focus-within { border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.1); }
  .token-label { font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:#6b7280; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
  .token-row { display:flex; align-items:center; gap:12px; }
  .token-text {
    flex:1; font-family:'SF Mono','Monaco','Inconsolata','Fira Mono','Droid Sans Mono',monospace;
    font-size:20px; font-weight:600; color:#059669; background:#f9fafb; padding:8px 12px; border-radius:8px; letter-spacing:2px; word-break:break-all;
  }
  .copy-btn {
    background:#10b981; color:white; border:none; border-radius:10px; padding:10px 20px;
    font-size:14px; font-weight:500; cursor:pointer; transition: all 0.2s ease; display:flex; align-items:center; gap:6px; white-space:nowrap;
  }
  .copy-btn:hover { background:#059669; transform:translateY(-1px); box-shadow:0 4px 6px rgba(16,185,129,0.2);}
  .copy-btn:active { transform:translateY(0); }

  /* -------------------- Steps -------------------- */
  .steps-container { background:#f9fafb; border-radius:16px; padding:20px; margin-top:24px; }
  .step { display:flex; align-items:flex-start; gap:12px; margin-bottom:16px; }
  .step:last-child { margin-bottom:0; }
  .step-number { width:24px; height:24px; background:#667eea; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:600; flex-shrink:0; }
  .step-content { flex:1; }
  .step-title { font-weight:600; color:#1f2937; font-size:15px; margin-bottom:4px; }
  .step-description { color:#6b7280; font-size:13px; line-height:1.4; }

  /* -------------------- Expired -------------------- */
  .expired-message { text-align:center; padding:20px; }
  .expired-icon { font-size:48px; margin-bottom:16px; color:#f59e0b; }
  .expired-title { color:#f59e0b; font-size:20px; font-weight:700; margin-bottom:12px; }
  .expired-text { color:#6b7280; font-size:14px; line-height:1.6; margin-bottom:24px; }

  /* -------------------- Buttons -------------------- */
  .primary-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color:white; border:none; border-radius:12px; padding:14px 24px;
    font-size:16px; font-weight:600; cursor:pointer; transition:all 0.2s ease; width:100%; text-decoration:none; display:inline-block;
  }
  .primary-btn:hover { transform:translateY(-2px); box-shadow:0 8px 15px rgba(102,126,234,0.3);}
  .primary-btn:active { transform:translateY(0); }

  .secondary-btn {
    background:white; color:#667eea; border:2px solid #667eea; border-radius:12px;
    padding:12px 24px; font-size:16px; font-weight:600; cursor:pointer; transition:all 0.2s ease; width:100%; text-decoration:none; display:inline-block; text-align:center;
  }
  .secondary-btn:hover { background:#f5f3ff; transform:translateY(-1px); }

  /* -------------------- Toast -------------------- */
  .toast {
    position: fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(100px);
    background:#1f2937; color:white; padding:12px 24px; border-radius:100px; font-size:14px; font-weight:500;
    box-shadow:0 4px 12px rgba(0,0,0,0.15); transition: transform 0.3s ease; z-index:1000;
  }
  .toast.show { transform:translateX(-50%) translateY(0); }
  .toast.success { background:#10b981; }

  /* -------------------- Loader -------------------- */
  .loader { display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:white; animation:spin 1s ease-in-out infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }

  .hidden { display:none; }
  .mt-4 { margin-top:16px; }
  .app-link-badge {
    background:#e8f0fe; border-radius:20px; padding:6px 12px; display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#1f2937; margin-bottom:16px;
  }
  .app-link-badge span { color:#10b981; font-size:14px; }
</style>
</head>
<body>
<div class="container" id="display-area"></div>

<script>
const params = new URLSearchParams(window.location.search);
const email = params.get('email');
const token = params.get('token');
const displayArea = document.getElementById('display-area');

const APP_LINKS_DOMAIN = 'https://signupconfirmation.netlify.app';
const DEEP_LINK_SCHEME = 'baseera://';

const showToast = (message, type='success') => {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(()=>toast.classList.add('show'),100);
  setTimeout(()=>{toast.classList.remove('show'); setTimeout(()=>document.body.removeChild(toast),300);},3000);
};

const copyToken = () => {
  if(!token) return;
  navigator.clipboard.writeText(token).then(()=>showToast('‚úì Token copied to clipboard!')).catch(()=>showToast('Failed to copy token','error'));
};

const openAppWithAppLinks = () => {
  if(!email||!token) return;
  const appLinksUrl = `${APP_LINKS_DOMAIN}/redirect.html?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}`;
  window.location.href = appLinksUrl;
  setTimeout(()=>{ window.location.href = `${DEEP_LINK_SCHEME}reset-password?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}`; },500);
};

const openAppManually = () => openAppWithAppLinks();

const showUI = (title,text,showToken=false,isExpired=false) => {
  if(isExpired){
    displayArea.innerHTML = `<div class="card">
      <div class="expired-message">
        <div class="expired-icon">‚è∞</div>
        <h2 class="expired-title">${title}</h2>
        <p class="expired-text">${text}</p>
        <a href="#" onclick="window.close()" class="primary-btn">Close Window</a>
        <p class="mt-4" style="color:#9ca3af;font-size:12px;">or request a new link from the app</p>
      </div></div>`;
    return;
  }

  displayArea.innerHTML = `<div class="card">
    <div class="logo">
      <div class="logo-circle">B</div>
      <div class="logo-text">Baseera</div>
    </div>

    ${!showToken?'<div class="app-link-badge"><span>‚úì</span> Verified App Link Active</div>':''}

    <h2>${title}</h2>
    <p class="subtitle">${text}</p>

    ${showToken?`<div class="info-box"><p>üîê <strong>Secure Token Generated</strong><br>Use this token in the app to complete your password reset.</p></div>
    <div class="token-container"><div class="token-label"><span>üîë Reset Token</span></div>
    <div class="token-row"><span class="token-text" id="token-text">${token}</span>
    <button class="copy-btn" onclick="copyToken()"><span>üìã</span> Copy</button></div></div>
    <div class="steps-container">
      <div class="step"><div class="step-number">1</div><div class="step-content">
      <div class="step-title">Copy the token</div><div class="step-description">Click the copy button above to save the reset token</div></div></div>
      <div class="step"><div class="step-number">2</div><div class="step-content">
      <div class="step-title">Open Baseera app</div><div class="step-description">Launch the app on your device and go to Reset Password</div></div></div>
      <div class="step"><div class="step-number">3</div><div class="step-content">
      <div class="step-title">Enter token</div><div class="step-description">Paste the token and create your new password</div></div></div>
    </div>
    <button onclick="openAppManually()" class="secondary-btn mt-4">Try Opening App Manually</button>`:
    `<div class="info-box"><p>${text}</p></div><a href="#" onclick="window.close()" class="primary-btn">Close Window</a>`}
  </div>`;
};

// -------------------- Main logic --------------------
if(!email||!token){
  showUI("Link Expired","This reset link is missing required information or has expired. Please request a new password reset from the Baseera app.",false,true);
}else{
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  const isAndroid = /Android/i.test(ua);
  const isIOS = /iPhone|iPad|iPod/i.test(ua);

  if(isAndroid || isIOS){
    // Mobile: show loader then try opening app
    displayArea.innerHTML = `<div class="card" style="text-align:center;">
      <div class="logo"><div class="logo-circle">B</div><div class="logo-text">Baseera</div></div>
      <div class="app-link-badge" style="margin:0 auto 16px;"><span>‚úì</span> Verified App Link Active</div>
      <h2>Opening App...</h2>
      <p class="subtitle">Using verified connection to open Baseera seamlessly</p>
      <div style="margin:30px 0;"><div class="loader"></div></div>
      <p style="color:#9ca3af;font-size:13px;">If app doesn't open automatically, click below</p>
      <button onclick="openAppWithAppLinks()" class="secondary-btn" style="margin-top:16px;">Open App Manually</button>
    </div>`;

    setTimeout(()=>openAppWithAppLinks(),1500);
    setTimeout(()=>showUI("App not opening?","Don't worry! You can still reset your password using the token below:",true),4000);

  }else{
    // Desktop/unsupported: show token UI directly
    showUI("Password Reset Token","Copy this token and use it in the Baseera app on your mobile device:",true);
  }
}
</script>
</body>
</html>
